# MQTT学习
- [MQTT学习](#mqtt学习)
- [1 MQTT简介](#1-mqtt简介)
- [2 MQTT结构](#2-mqtt结构)
  - [2.1 固定头部](#21-固定头部)
  - [2.2 可变头部](#22-可变头部)
  - [2.3 消息载荷](#23-消息载荷)
  - [2.4 结果状态码](#24-结果状态码)
- [3 MQTT控制包](#3-mqtt控制包)
  - [3.1 连接请求](#31-连接请求)
    - [3.1.1 固定头部](#311-固定头部)
    - [3.1.2 可变头部](#312-可变头部)

# 1 MQTT简介
&emsp;&emsp;MQTT作为一种传输协议，可以以很小的网络带宽进行发送数据，适用于物联网等设备功耗小，网络带宽小的情景中。MQTT作为一种应用协议建立在TCP或其他稳定、顺序、不丢包等传输协议上。MQTT相对简单，便于实现，通过发布与订阅方式进行消息的传输。MQTT应用中需要一个server作为消息的中转，不同的client作为消息生产者与消费者。 本文档通过mqtt5版本进行学习。  
# 2 MQTT结构
&emsp;&emsp;MQTT协议定义了数据包的传输方式，MQTT中消息通过数据包的形式进行传输。数据包主要包括三个部分：固定头部、可变头部以及消息载荷。固定头部为每个数据包都具有的部分，可变头部与消息载荷是可选的部分。
## 2.1 固定头部  
&emsp;&emsp;可以将固定头部分为两部分，第一部分为第一个字节，高四位为数据包的类型，低四位为数据包类型的flags；第二部分为预留长度。以下为数据包类型表。

| 名称 | 值 |  数据流方向 | 描述 |
| ---- | ---- | ---- | ---- |
| Reserved | 0 | Forbidden | 预留 |
| CONNECT	| 1 | 客户端到服务器 |	连接请求 |
| CONNACK	| 2 | 服务器到客户端 |	连接确认 |
| PUBLISH	| 3 | 客户端与服务器双向 |	发布消息 |
| PUBACK	| 4 | 客户端与服务器双向 |	发布消息确认(QoS 1) |
| PUBREC	| 5 | 客户端与服务器双向 |	发布消息已收到(QoS 2投递第一部分) |
| PUBREL	| 6 | 客户端与服务器双向 |	发布消息已释放(QoS 2投递第二部分) |
| PUBCOMP	| 7 | 客户端与服务器双向 |	发布消息已完成(QoS 2投递第三部分) |
| SUBSCRIBE	| 8 | 客户端到服务器 |	订阅请求 |
| SUBACK	| 9 | 服务器到客户端 |	订阅确认 |
| UNSUBSCRIBE | 10 | 客户端到服务器 |	取消订阅请求 |
| UNSUBACK	| 11 | 服务器到客户端 |	取消订阅确认 |
| PINGREQ	| 12 | 客户端到服务器 |	PING请求 |
| PINGRESP	| 13 | 服务器到客户端 |	PING确认 |
| DISCONNECT | 14 | 客户端与服务器双向 |	断开连接通知 |
| AUTH	| 15 | 客户端与服务器双向 |	身份认证交换 |

低四位为flag，如果flag为Reserved则标识会在未来使用，必须将其设置为默认值。以下表为数据包类型对应的flag。
| 包 | 固定头flag |  Bit3 | Bit2 | Bit1 | Bit0 |
| ---- | ---- | ---- | ---- | ---- | ---- |
| CONNECT	| Reserved | 0 | 0 | 0 | 0 |
| CONNACK	| Reserved | 0 | 0 | 0 | 0 |
| PUBLISH	| v5.0 | DUP |	QoS | QoS | RETAIN |
| PUBACK	| Reserved | 0 | 0 | 0 | 0 |
| PUBREC	| Reserved | 0 | 0 | 0 | 0 |
| PUBREL	| Reserved | 0 | 0 | 1 | 0 |
| PUBCOMP	| Reserved | 0 | 0 | 0 | 0 |
| SUBSCRIBE	| Reserved | 0 | 0 | 1 | 0 |
| SUBACK	| Reserved | 0 | 0 | 0 | 0 |
| UNSUBSCRIBE | Reserved | 0 | 0 | 1 | 0 |
| UNSUBACK	| Reserved | 0 | 0 | 0 | 0 |
| PINGREQ	| Reserved | 0 | 0 | 0 | 0 |
| PINGRESP	| Reserved | 0 | 0 | 0 | 0 |
| DISCONNECT | Reserved | 0 | 0 | 0 | 0 |
| AUTH	| Reserved | 0 | 0 | 0 | 0 |

&emsp;&emsp;预留长度为一个可变的整数，表示除固定头部外剩余数据长度（不包括预留长度本身），包括可变头以及有效载荷的数据。数据包总长度为固定头部长度加预留长度之和。

## 2.2 可变头部
可变头部是可选的部分，位于固定头部与消息载荷之间。可变头部的内容取决于消息包的类型，一些数据包的可变头的消息包认定字段是相同的。可变头还包括一些属性信息。

## 2.3 消息载荷

## 2.4 结果状态码
结果状态码为一个byte的正整数，表示操作的结果状态。如果状态码小于0x80则表示完成任务操作，一般成功用状态码0表示，失败用大于0x80数表示。

# 3 MQTT控制包
## 3.1 连接请求
&emsp;&emsp;当客户端与服务器建立连接之后，客户端发送的第一个数据包必须为连接请求。服务器接收同一个客户端的第二个连接请求，必须将其视为错误并断开连接。连接请求的有效载荷包含一个或多个字段，包括客户端的唯一标识，遗嘱主题，遗嘱载荷、用户名以及密码。除了客户端标识其他都可以省略。可变头部按照顺序为协议名称、协议等级、连接flag、keep alive以及一些属性。
### 3.1.1 固定头部
| 名称 | 值 | 含义 |
| ---- | ---- | ---- |
| 包类型 | 00010000 | connect类型 |
| 预留长度 | 00001000 | 可变头与载荷长度 |

### 3.1.2 可变头部
- 1 协议名称表  

| 名称 | 值 | 含义 |
| ---- | ---- | ---- |
| 协议名称1 | 00000000 | MSB（0） |
| 协议名称2 | 00000100 | LSB（4） |
| 协议名称1 | 01001101 | 'M' |
| 协议名称1 | 01010001 | 'Q' |
| 协议名称1 | 01010100 | 'T' |
| 协议名称1 | 01010100 | 'T' |

- 2 协议版本表，客户端与服务器版本需要一致如果不一致则需要将客户端断开。

| 名称 | 值 | 含义 |
| ---- | ---- | ---- |
| 协议版本5| 00000101 | 5 |

- 3 连接flag包含一些连接的参数，在载荷中存在或不存在该属性，连接请求必须将连接的flag中Reserved属性设置为0，如果不为0则表示为无效连接。

| Bit | 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
|      | User Name Flag | Password Flag | Will Retain | Will QoS | Will QoS | Will Flag | Clean Start | Reserved |
| byte8| x | x | x | x | x | x | x | 0 |

clean start为连接flag的位置1bit，表示是否新启动一个连接或是继续之前的连接。如果clean start为1则表示需要丢弃之前的session然后开始新的session。如果clean start设置为1则CONNACK中Session Present Flag需要设置为0.如果clean start为0并且当前存在具有绑定用户标识的连接，则服务器需要利用该连接与客户端通信。如果设置为0但没有绑定用户标识的连接，服务器必须重新创建新的Session。will Flag位于2bit位置，如果will flag设置为1，则表示服务器必须将will message进行保存，并且与session关联。will message包括will properties， will topic，以及在CONNECT载荷中的will payload属性。遗嘱消息必须在连接断开、session关闭或是遗嘱延迟时间到期后被发布出去。如果服务端收到正常关闭连接则消息会被服务端删除，或在遗嘱到期之前开启了新的连接，遗嘱不会被发布出去。当遗嘱被发送或正常关闭连接时遗嘱会被服务端删除。如果will flag设置为1载荷中必须包括will properties， will topic，以及will payload属性。如果服务端挂了，在重启之后可能会继续发送遗嘱信息，延迟时间需要在服务端重启之后累计。Will QoS为3和4bit位置，如果will flag设置为0则will QoS必须设置为0，如果will flag设置为1，will QoS可以设置为0、1、2。3为非法值。will retain位于5bit，标识当遗嘱发送出去之后是否需要保存。如果will flag设置为0，则will retain必须设置为0.User Name Flag位于7bit，如果值为0，载荷中必须不包括用户名字段；如果值为1，载荷中必须包括用户字段。Password Flag位于6bit，如果值为0，载荷中必须不包括用密码字段；如果值为1，载荷中必须包括密码字段。

- 4 keep alive包括两个byte组成，秒时间测量。用来表示客户端发送两个消息包之间的最大时间间隔，客户端需要保证在消息发送之前时间差不能大于keep alive。如果keep alive设置不为0的数，在没有数据包发送时客户端必须发送PINGREQ包。客户端需要将server在CONNACK中返回的server keep alive替换自己发送的keep alive值作为过期时间长度。如果keep alive不为0，但服务端在keep alive值 * 1.5时间内没有收到消息包，则视为网络出现问题，并将连接关闭。如果客户端在一定时间内没有收到PINGRSP则需要将其关闭。如果keep alive设置为0则发送消息没有时间限制。
- 5 连接属性
属性长度；session的有效期17byte数据，如果网络连接关闭了，服务端与客户端都需要保存session状态。
